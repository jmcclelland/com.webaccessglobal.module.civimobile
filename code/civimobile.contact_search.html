<div id="jqm-contactsheader" data-role="header">
  <h3>Search Contacts</h3>
  <a href="<?php echo CRM_Utils_System::url('civicrm/mobile/'); ?>" data-ajax="false" id="home-main" data-transition="slide" data-direction="reverse" data-role="button" data-icon="home" data-iconpos="notext" class="ui-btn-left jqm-home">Home</a>
  <a href="#addContactPopup"  style="text-decoration: none" id="add-contact-button" data-role="button" data-icon="plus" class="ui-btn-right jqm-home" data-rel="popup">Add</a>
</div>
<div data-role="popup" id="addContactPopup" data-transition="slidedown">
  <ul data-role="listview" data-inset="true" style="min-width:210px;" data-theme="a">
    <li data-role="divider" data-theme="a">Contact type:</li>
    <?php
      $params = array(
        'return' => 'id',
        'name' => 'new_individual',
      );
      try {
        $default_ind_profile_id = civicrm_api3('uf_group', 'getvalue', $params);
      }
      catch (CiviCRM_API3_Exception $e) {
        // What do we do with errors?
        // Revert to hard coded ids
        $default_ind_profile_id = 10;
      }

      $params = array(
        'return' => 'id',
        'name' => 'new_organization',
      );
      try {
        $default_org_profile_id= civicrm_api3('uf_group', 'getvalue', $params);
      }
      catch (CiviCRM_API3_Exception $e) {
        $default_org_profile_id = 5; 
      }
      $params = array(
      'return' => 'id',
      'name' => 'new_household',
      );
      try {
        $default_house_profile_id = civicrm_api3('uf_group', 'getvalue', $params);
      }
      catch (CiviCRM_API3_Exception $e) {
        $default_house_profile_id = 6;
      }
      $group = 'CiviCRM Mobile';
      $ind_profile_id = CRM_Core_BAO_Setting::getItem($group, 'ind_profile_id', NULL, $default_ind_profile_id);
      $org_profile_id = CRM_Core_BAO_Setting::getItem($group, 'org_profile_id', NULL, $default_org_profile_id);
      $house_profile_id = CRM_Core_BAO_Setting::getItem($group, 'house_profile_id', NULL, $default_house_profile_id);

    ?>
    <li><a href="<?php echo CRM_Utils_System::url('civicrm/mobile/contact', "action=add&pid={$ind_profile_id}"); ?>" data-transition="slideup">Individual</a></li>
    <li><a href="<?php echo CRM_Utils_System::url('civicrm/mobile/contact', "action=add&pid={$org_profile_id}"); ?>" data-transition="slideup">Organization</a></li>
    <li><a href="<?php echo CRM_Utils_System::url('civicrm/mobile/contact', "action=add&pid={$house_profile_id}"); ?>" data-transition="slideup">Household</a></li>
  </ul>
</div>
<div data-role="content" id="contact-content">
  <div class="ui-listview-filter ui-bar-c">
    <input type="search" name="sort_name" id="sort_name" value="" />
  </div>
  <ul id="contacts" data-role="listview" data-inset="false" data-filter="false"></ul>
</div>

<br/>

<div>
  <a href="#cm-proximity-search" id="proximity-search-button" data-role="button" data-transition="slideup">Proximity Search</a>
</div>

<script>
  function contactSearch (q) {
    $.mobile.showPageLoadingMsg( 'Searching' );
    CRM.api('Contact','get',
      {'version' :'3', 'sort_name': q, 'return' : 'display_name' },
      {
        success:function (data){
          if (data.count == 0) {
            cmd = null;
          }
          else {
            cmd = "refresh";
            $('#contacts').show();
            $('#contacts').empty();
          }
          $.each(data.values, function(key, value) {
            $('#contacts').append('<li role="option" tabindex="-1" data-theme="c" id="event-'+value.contact_id+'" ><a href="<?php echo CRM_Utils_System::url('civicrm/mobile/contact', 'action=view&cid='); ?>'+value.contact_id+'" data-transition="slideup"  data-role="contact-'+value.contact_id+'">'+value.display_name+'</a></li>');
          });
          $.mobile.hidePageLoadingMsg( );
          $('#contacts').listview(cmd);
        }
      });
  }
</script>

